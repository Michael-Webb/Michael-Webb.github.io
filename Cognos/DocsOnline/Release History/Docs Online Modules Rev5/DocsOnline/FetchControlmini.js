define([],(function(){"use strict";class e{initialize(e,t){try{this.oControlHost=e;const r=e.configuration;if(!0===r["Dev Mode"]){if(!r["Development Server Url"])throw console.warn("DocumentsOnline: Dev mode is enabled but no Development Server Url is configured."),this.hasValidConfiguration=!1,new scriptableReportError("DocumentsOnline","initialize","Dev mode is enabled but no Development Server Url is configured.")}else if(!r["Server Url"])throw console.warn("DocumentsOnline: Production mode is active but no Server Url is configured."),this.hasValidConfiguration=!1,new scriptableReportError("DocumentsOnline","initialize","Production mode is active but no Server Url is configured.");this.hasValidConfiguration=!0,this.showConsoleMessages=r["Show Console Messages"]??!0,this.sServerUrl=r["Server Url"],this.sDevUrl=r["Development Server Url"],this.isDevMode=r["Dev Mode"],this.iconHeight=r["Icon Height"],this.iconWidth=r["Icon Width"],this.useExclude=r.Use_Exclude,this.excludeValue=r.Exclude_Value,this.showIconText=r["Show Icon/Text"],this.label=r.Label,this.processSpanType=r.Type,this.useLazyLoading=!1!==r["Use Lazy Loading"],this.requestCache=new Map,t()}catch(e){console.error("Error during DocumentsOnline initialization:",e),this.hasValidConfiguration=!1,t()}}draw(e){if(this.hasValidConfiguration)try{this.setupLazyLoading()}catch(e){console.error("Error during DocumentsOnline draw:",e)}else console.warn("DocumentsOnline: Skipping draw due to invalid configuration")}showLoadingIcon(t){try{if(!t)return;const r=document.createElement("a");r.id=`${t.id}link`,r.innerHTML=e.getClockSVG(this.iconWidth,this.iconHeight),t.setAttribute("data-status","document loading"),t.setAttribute("title","Attachment Loading"),t.appendChild(r)}catch(e){console.error("Error showing loading icon:",e)}}updatePaperclip(t,r){try{if(!t)return;if(!r||"string"!=typeof r)throw new Error("Invalid destination URL");const o=t.querySelector(`#${t.id}link`);if(!o)throw new Error("Link element not found in container");{o.href=r,o.target="_blank";const t=this.label&&""!==this.label.trim()?this.label:"View Attachment",n=this.showIconText&&""!==this.showIconText.trim()?this.showIconText:"icon";let s="";s="icon"===n.toLowerCase()?e.getPaperclipSVG(this.iconWidth,this.iconHeight):"text"===n.toLowerCase()?t:"both"===n.toLowerCase()?e.getPaperclipSVG(this.iconWidth,this.iconHeight)+" "+t:e.getPaperclipSVG(this.iconWidth,this.iconHeight),o.innerHTML=s}t.setAttribute("data-status","document found"),t.setAttribute("title","View Attachment Document")}catch(e){console.error("Error updating paperclip:",e),this.handleSpanError(t,t.dataset.ref||"unknown",e)}}removeLoadingIcon(e){try{if(!e)return;const t=e.querySelector(`#${e.id}link`);t&&t.remove(),e.setAttribute("data-status","no document found")}catch(e){console.error("Error removing loading icon:",e)}}handleSpanError(t,r,o){if(console.error("Error processing attachment",r,o),t){const r=t.querySelector(`#${t.id}link`);r&&(r.innerHTML=e.getErrorSVG(this.iconWidth,this.iconHeight)),t.setAttribute("data-status","error"),t.setAttribute("title","Error loading attachment: "+o.message)}}processSpanXML(t){try{const{token:r,arg:o,user:n,env:s,ref:i}=t.dataset,a=t.getAttribute("data-status")||"new";if(!(r&&o&&n&&s))throw new Error("Missing required data attributes on span element");if(this.useExclude&&i&&i.startsWith(this.excludeValue))return void t.setAttribute("data-status","no document found");if("new"!==a&&1==this.showConsoleMessages)return void console.log(i,"already processed:",a);this.showLoadingIcon(t);const c=e.url_Decode(o).replace(/\\/g,""),h=encodeURI(e.fEncode(c)),l=this.isDevMode?this.sDevUrl:this.sServerUrl;if(!l)throw new Error("Server URL is not configured");const d=`${l}arg=${h}&env=${e.url_Decode(s)}&user=${n}&token=${r}`,u=e=>{if(1===e)this.removeLoadingIcon(t),1==this.showConsoleMessages&&console.log(i," no document found");else try{const r=e.getElementsByTagName("value")[0];if(!r||!r.childNodes[0])throw new Error("Invalid XML response format");const o=r.childNodes[0].nodeValue;this.updatePaperclip(t,o),1==this.showConsoleMessages&&console.log(i," document found:",o)}catch(e){this.handleSpanError(t,i,e)}};if(this.requestCache.has(d))return void this.requestCache.get(d).then(u).catch((e=>this.handleSpanError(t,i,e)));const g=fetch(d,{method:"GET",headers:{token:r,user:n}}).then((e=>{if(!e.ok)throw new Error(`Network response was not ok: ${e.status} ${e.statusText}`);return e.text()})).then((e=>{if(!e.trim())return 1;try{const t=(new window.DOMParser).parseFromString(e,"text/xml"),r=t.querySelector("parsererror");if(r)throw new Error("XML parsing error: "+r.textContent);return t}catch(e){throw new Error("Failed to parse XML response: "+e.message)}}));this.requestCache.set(d,g),g.then(u).catch((e=>this.handleSpanError(t,i,e)))}catch(e){this.handleSpanError(t,t.dataset.ref||"unknown",e)}}processSpanHTML(t){try{const{token:r,arg:o,user:n,env:s,ref:i}=t.dataset,a=t.getAttribute("data-status")||"new";if(!(r&&o&&n&&s))throw new Error("Missing required data attributes on span element");if(this.useExclude&&i&&i.startsWith(this.excludeValue))return void t.setAttribute("data-status","no document found");if("new"!==a&&1==this.showConsoleMessages)return void console.log(i,"already processed:",a);this.showLoadingIcon(t);const c=e.url_Decode(o).replace(/\\/g,""),h=encodeURI(e.fEncode(c)),l=this.isDevMode?this.sDevUrl:this.sServerUrl;if(!l)throw new Error("Server URL is not configured");const d=`${l}arg=${h}&env=${e.url_Decode(s)}&user=${n}&token=${r}&html=true`,u=e=>{if(1===e)this.removeLoadingIcon(t),1==this.showConsoleMessages&&console.log(i," no document found");else try{const r=e.querySelector("a");if(!r)throw new Error("No anchor element found in HTML response");const o=r.getAttribute("href");if(!o)throw new Error("Anchor element has no href attribute");this.updatePaperclip(t,o),1==this.showConsoleMessages&&console.log(i," document found:",o)}catch(e){this.handleSpanError(t,i,e)}};if(this.requestCache.has(d))return void this.requestCache.get(d).then(u).catch((e=>this.handleSpanError(t,i,e)));const g=fetch(d,{method:"GET",headers:{token:r,user:n}}).then((e=>{if(!e.ok)throw new Error(`Network response was not ok: ${e.status} ${e.statusText}`);return e.text()})).then((e=>{if(!e.trim())return 1;try{const t=(new window.DOMParser).parseFromString(e,"text/html"),r=t.querySelector("parsererror");if(r)throw new Error("HTML parsing error: "+r.textContent);return t}catch(e){throw new Error("Failed to parse HTML response: "+e.message)}}));this.requestCache.set(d,g),g.then(u).catch((e=>this.handleSpanError(t,i,e)))}catch(e){this.handleSpanError(t,t.dataset.ref||"unknown",e)}}setupLazyLoading(){try{const e=document.querySelectorAll("span[name='attachments']");if(!e||0===e.length)return void console.warn("DocumentsOnline: No attachment spans found in document");const t=this.processSpanType&&"html"===this.processSpanType.toLowerCase()?this.processSpanHTML.bind(this):this.processSpanXML.bind(this);if(!this.useLazyLoading)return this.showConsoleMessages&&console.log("DocumentsOnline: Using eager loading mode"),void e.forEach((e=>{try{t(e)}catch(t){this.handleSpanError(e,e.dataset.ref||"unknown",t)}}));if(this.showConsoleMessages&&console.log("DocumentsOnline: Using lazy loading mode"),"IntersectionObserver"in window){const r=new IntersectionObserver(((e,r)=>{e.forEach((e=>{if(e.isIntersecting)try{t(e.target)}catch(t){this.handleSpanError(e.target,e.target.dataset.ref||"unknown",t)}finally{r.unobserve(e.target)}}))}),{threshold:.1});e.forEach((e=>{try{r.observe(e)}catch(r){console.error("Failed to observe span:",r),t(e)}}))}else console.warn("DocumentsOnline: IntersectionObserver not supported, falling back to immediate loading"),e.forEach((e=>{try{t(e)}catch(t){this.handleSpanError(e,e.dataset.ref||"unknown",t)}}))}catch(e){throw new scriptableReportError("DocumentsOnline","setupLazyLoading","Failed to setup lazy loading: "+e.message)}}static fEncode(e){var t={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var r,o,n,s,i,a,c,h="",l=0;for(e=t._utf8_encode(e);l<e.length;)s=(r=e.charCodeAt(l++))>>2,i=(3&r)<<4|(o=e.charCodeAt(l++))>>4,a=(15&o)<<2|(n=e.charCodeAt(l++))>>6,c=63&n,isNaN(o)?a=c=64:isNaN(n)&&(c=64),h=h+this._keyStr.charAt(s)+this._keyStr.charAt(i)+this._keyStr.charAt(a)+this._keyStr.charAt(c);return h},decode:function(e){var r,o,n,s,i,a,c="",h=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");h<e.length;)r=this._keyStr.indexOf(e.charAt(h++))<<2|(s=this._keyStr.indexOf(e.charAt(h++)))>>4,o=(15&s)<<4|(i=this._keyStr.indexOf(e.charAt(h++)))>>2,n=(3&i)<<6|(a=this._keyStr.indexOf(e.charAt(h++))),c+=String.fromCharCode(r),64!=i&&(c+=String.fromCharCode(o)),64!=a&&(c+=String.fromCharCode(n));return c=t._utf8_decode(c)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",r=0;r<e.length;r++){var o=e.charCodeAt(r);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t},_utf8_decode:function(e){for(var t="",r=0,o=c1=c2=0;r<e.length;)(o=e.charCodeAt(r))<128?(t+=String.fromCharCode(o),r++):o>191&&o<224?(c2=e.charCodeAt(r+1),t+=String.fromCharCode((31&o)<<6|63&c2),r+=2):(c2=e.charCodeAt(r+1),c3=e.charCodeAt(r+2),t+=String.fromCharCode((15&o)<<12|(63&c2)<<6|63&c3),r+=3);return t}};return t.encode(e)}static url_Decode(e){return decodeURIComponent(e.replaceAll("+"," "))}static getClockSVG(e,t){return`<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`}static getPaperclipSVG(e,t){return`<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-paperclip"><path d="M13.234 20.252 21 12.3"/><path d="m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486"/></svg>`}static getErrorSVG(e,t){return`<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`}}return e}));